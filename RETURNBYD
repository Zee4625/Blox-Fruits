local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local REVIVE_SOUND_ID = "rbxassetid://18597544476"
local lastDeathCFrame = nil

-- Salvează poziția la moarte
local function onHumanoidDied(humanoid)
	if humanoid and humanoid.RootPart then
		lastDeathCFrame = humanoid.RootPart.CFrame
	elseif player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
		lastDeathCFrame = player.Character.HumanoidRootPart.CFrame
	end
end

-- Sunet epic de revive
local function playReviveSound()
	local sound = Instance.new("Sound")
	sound.SoundId = REVIVE_SOUND_ID
	sound.Volume = 0
	sound.Parent = workspace.CurrentCamera
	sound:Play()
	for i = 0, 1, 0.1 do
		sound.Volume = i * 4
		task.wait(0.03)
	end
	task.delay(2, function()
		for i = 1, 0, -0.1 do
			sound.Volume = i * 4
			task.wait(0.03)
		end
		sound:Stop()
		sound:Destroy()
	end)
end

-- Time rewind efect vizual
local function timeRewindEffect()
	local gui = player:WaitForChild("PlayerGui")
	local rewindFrame = Instance.new("Frame")
	rewindFrame.Size = UDim2.new(1,0,1,0)
	rewindFrame.BackgroundColor3 = Color3.new(1,1,1)
	rewindFrame.BackgroundTransparency = 1
	rewindFrame.ZIndex = 20
	rewindFrame.Parent = gui

	local blur = Instance.new("BlurEffect")
	blur.Size = 0
	blur.Parent = Lighting

	local tweenIn = TweenService:Create(rewindFrame, TweenInfo.new(0.2), {BackgroundTransparency = 0.6})
	local blurIn = TweenService:Create(blur, TweenInfo.new(0.2), {Size = 15})
	tweenIn:Play()
	blurIn:Play()

	local cam = workspace.CurrentCamera
	local startCF = cam.CFrame
	local elapsed = 0
	local conn
	conn = RunService.RenderStepped:Connect(function(dt)
		elapsed += dt
		if elapsed > 0.3 then
			conn:Disconnect()
			cam.CFrame = startCF
		else
			local offset = Vector3.new((math.random()-0.5)*0.15, (math.random()-0.5)*0.15, 0)
			cam.CFrame = startCF * CFrame.new(offset)
		end
	end)

	task.delay(0.3, function()
		local tweenOut = TweenService:Create(rewindFrame, TweenInfo.new(0.2), {BackgroundTransparency = 1})
		local blurOut = TweenService:Create(blur, TweenInfo.new(0.2), {Size = 0})
		tweenOut:Play()
		blurOut:Play()
		task.delay(0.25, function()
			rewindFrame:Destroy()
			blur:Destroy()
		end)
	end)
end

-- Efect cinematic pe ecran
local function showScreenEffect()
	local gui = player:WaitForChild("PlayerGui")
	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(1,0,1,0)
	frame.BackgroundColor3 = Color3.fromRGB(40,120,255)
	frame.BackgroundTransparency = 1
	frame.ZIndex = 15
	frame.Parent = gui

	-- Text cinematic
	local textLabel = Instance.new("TextLabel")
	textLabel.Text = "Return by Death"
	textLabel.TextColor3 = Color3.fromRGB(255,255,255)
	textLabel.Font = Enum.Font.Bangers
	textLabel.TextScaled = true
	textLabel.BackgroundTransparency = 1
	textLabel.Size = UDim2.new(1,0,0.2,0)
	textLabel.Position = UDim2.new(0,0,0.4,0)
	textLabel.ZIndex = 16
	textLabel.Parent = gui

	local tweenIn = TweenService:Create(frame, TweenInfo.new(0.3), {BackgroundTransparency = 0.3})
	local tweenOut = TweenService:Create(frame, TweenInfo.new(0.5), {BackgroundTransparency = 1})
	tweenIn:Play()
	tweenIn.Completed:Wait()

	-- Puls text
	for i = 1,0,-0.05 do
		textLabel.TextTransparency = i
		task.wait(0.03)
	end
	for i = 0,1,0.05 do
		textLabel.TextTransparency = i
		task.wait(0.03)
	end

	tweenOut:Play()
	tweenOut.Completed:Wait()
	frame:Destroy()
	textLabel:Destroy()
end

-- Respawn instant cinematic
local function respawnAtLastDeath()
	if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and lastDeathCFrame then
		local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
		player.Character.HumanoidRootPart.CFrame = lastDeathCFrame
		if humanoid then humanoid.Health = humanoid.MaxHealth end

		playReviveSound()
		timeRewindEffect()
		showScreenEffect()

		task.wait(0.2) -- mic wait cinematic
	end
end

-- Conectare character
local function onCharacterAdded(char)
	local humanoid = char:WaitForChild("Humanoid")
	humanoid.Died:Connect(function()
		onHumanoidDied(humanoid)
	end)
	respawnAtLastDeath()
end

player.CharacterAdded:Connect(onCharacterAdded)
if player.Character then
	onCharacterAdded(player.Character)
end
