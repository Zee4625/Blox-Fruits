--[[
    ðŸŒŒ NPC Radar + Motion Highlight + Night Vision (tasta M)
    â–¸ Radar modern, tu mereu Ã®n centru
    â–¸ Plasat Ã®n colÈ›ul dreapta sus
    â–¸ Night Vision dedesubt
    â–¸ Indicator "N" deasupra radarului
--]]

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")

local LOCAL_PLAYER = Players.LocalPlayer

-- CONFIG
local CHECK_INTERVAL = 0.25
local MOVE_THRESHOLD = 0.05
local IDLE_TIMEOUT = 0.5
local RADAR_SIZE = 170
local RADAR_RANGE = 120

-- STORAGE
local tracked = {}
local radarDots = {}
local nightVisionOn = false

---------------------------------------------------------
-- GUI
---------------------------------------------------------
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "RadarGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LOCAL_PLAYER:WaitForChild("PlayerGui")

-- Radar container
local RadarFrame = Instance.new("Frame")
RadarFrame.Name = "Radar"
RadarFrame.Size = UDim2.new(0, RADAR_SIZE, 0, RADAR_SIZE)
RadarFrame.Position = UDim2.new(1, -RADAR_SIZE - 10, 0, 10) -- colÈ›ul sus-dreapta
RadarFrame.BackgroundColor3 = Color3.fromRGB(15, 25, 15)
RadarFrame.BackgroundTransparency = 0.25
RadarFrame.BorderSizePixel = 0
RadarFrame.Parent = ScreenGui
RadarFrame.ClipsDescendants = true

local RadarCorner = Instance.new("UICorner")
RadarCorner.CornerRadius = UDim.new(1, 0)
RadarCorner.Parent = RadarFrame

-- Border circular verde
local Border = Instance.new("UIStroke")
Border.Thickness = 2
Border.Color = Color3.fromRGB(0, 255, 0)
Border.Transparency = 0.3
Border.Parent = RadarFrame

-- Titlu
local RadarTitle = Instance.new("TextLabel")
RadarTitle.Size = UDim2.new(1, 0, 0, 20)
RadarTitle.Text = "ðŸ“¡ RADAR"
RadarTitle.TextColor3 = Color3.fromRGB(0, 255, 0)
RadarTitle.BackgroundTransparency = 1
RadarTitle.Font = Enum.Font.GothamBold
RadarTitle.TextSize = 16
RadarTitle.Parent = RadarFrame

-- Indicator N (North) deasupra radarului
local NorthIndicator = Instance.new("TextLabel")
NorthIndicator.Size = UDim2.new(0, 20, 0, 20)
NorthIndicator.Position = UDim2.new(0.5, -10, 0, -25) -- deasupra radarului
NorthIndicator.Text = "N"
NorthIndicator.TextColor3 = Color3.fromRGB(0, 255, 0)
NorthIndicator.BackgroundTransparency = 1
NorthIndicator.Font = Enum.Font.GothamBold
NorthIndicator.TextSize = 18
NorthIndicator.ZIndex = 3
NorthIndicator.Parent = RadarFrame

-- Night Vision indicator (puÈ›in dedesubt)
local NightVisionBtn = Instance.new("TextLabel")
NightVisionBtn.Name = "NightVisionIndicator"
NightVisionBtn.Size = UDim2.new(1, -10, 0, 24)
NightVisionBtn.Position = UDim2.new(0, 5, 1, -30) -- dedesubt
NightVisionBtn.Text = "ðŸŒ™ Night Vision: OFF (M)"
NightVisionBtn.Font = Enum.Font.Gotham
NightVisionBtn.TextSize = 14
NightVisionBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
NightVisionBtn.BackgroundColor3 = Color3.fromRGB(25, 80, 25)
NightVisionBtn.BackgroundTransparency = 0.1
NightVisionBtn.Parent = RadarFrame

local NVCorner = Instance.new("UICorner")
NVCorner.CornerRadius = UDim.new(0, 6)
NVCorner.Parent = NightVisionBtn

---------------------------------------------------------
-- UTILS
---------------------------------------------------------
local function getPos(obj)
	if not obj or not obj.Parent then return nil end
	if obj:IsA("BasePart") then
		return obj.Position
	elseif obj:IsA("Model") then
		local hrp = obj:FindFirstChild("HumanoidRootPart")
		if hrp then return hrp.Position end
	end
	return nil
end

local function isNPC(obj)
	return obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and not Players:GetPlayerFromCharacter(obj)
end

local function makeHighlight(obj, color)
	local h = Instance.new("Highlight")
	h.Name = "MoveHighlight"
	h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	h.FillTransparency = 0.7
	h.OutlineTransparency = 0.4
	h.FillColor = color
	h.OutlineColor = color
	h.Adornee = obj:IsA("Model") and obj:FindFirstChild("HumanoidRootPart") or obj
	h.Parent = CoreGui
	return h
end

---------------------------------------------------------
-- RADAR UPDATE
---------------------------------------------------------
local function updateRadar()
	for _, dot in pairs(radarDots) do
		dot:Destroy()
	end
	radarDots = {}

	local char = LOCAL_PLAYER.Character
	local root = char and char:FindFirstChild("HumanoidRootPart")
	if not root then return end

	local center = Vector2.new(RADAR_SIZE / 2, RADAR_SIZE / 2)

	-- punctul jucÄƒtorului
	local selfDot = Instance.new("Frame")
	selfDot.Size = UDim2.new(0, 8, 0, 8)
	selfDot.Position = UDim2.new(0, center.X - 4, 0, center.Y - 4)
	selfDot.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
	selfDot.BorderSizePixel = 0
	selfDot.ZIndex = 2
	selfDot.Parent = RadarFrame
	table.insert(radarDots, selfDot)

	for obj, info in pairs(tracked) do
		if obj and obj.Parent and info.hl then
			local pos = getPos(obj)
			if pos then
				local rel = pos - root.Position
				local x, z = rel.X, rel.Z
				local dist = math.sqrt(x^2 + z^2)
				if dist < RADAR_RANGE then
					local scale = (RADAR_SIZE / 2 - 10) / RADAR_RANGE
					local scaledX = x * scale
					local scaledZ = z * scale

					local dot = Instance.new("Frame")
					dot.Size = UDim2.new(0, 6, 0, 6)
					dot.Position = UDim2.new(0, center.X + scaledX - 3, 0, center.Y + scaledZ - 3)
					dot.BackgroundColor3 = info.isNPC and Color3.fromRGB(255, 60, 60) or Color3.fromRGB(0, 200, 255)
					dot.BorderSizePixel = 0
					dot.BackgroundTransparency = 0.1
					dot.ZIndex = 1
					dot.Parent = RadarFrame

					task.spawn(function()
						dot:TweenSize(UDim2.new(0, 8, 0, 8), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.15, true)
						task.wait(0.15)
						if dot then
							dot:TweenSize(UDim2.new(0, 6, 0, 6), Enum.EasingDirection.In, Enum.EasingStyle.Quad, 0.15, true)
						end
					end)

					table.insert(radarDots, dot)
				end
			end
		end
	end
end

---------------------------------------------------------
-- TRACKING
---------------------------------------------------------
local function tryTrack(obj)
	if isNPC(obj) or (obj:IsA("BasePart") and not obj:FindFirstAncestorOfClass("Model")) then
		local pos = getPos(obj)
		if pos then
			tracked[obj] = {
				lastPos = pos,
				lastMove = tick(),
				hl = nil,
				isNPC = isNPC(obj)
			}
		end
	end
end

local function stopTrack(obj)
	local info = tracked[obj]
	if info then
		if info.hl then info.hl:Destroy() end
		tracked[obj] = nil
	end
end

for _, obj in ipairs(Workspace:GetDescendants()) do
	tryTrack(obj)
end

Workspace.DescendantAdded:Connect(tryTrack)
Workspace.DescendantRemoving:Connect(stopTrack)

---------------------------------------------------------
-- LOOP
---------------------------------------------------------
task.spawn(function()
	while true do
		task.wait(CHECK_INTERVAL)
		local t = tick()
		for obj, info in pairs(tracked) do
			if obj and obj.Parent then
				local pos = getPos(obj)
				if pos then
					local moved = (pos - info.lastPos).Magnitude > MOVE_THRESHOLD
					if moved then
						info.lastPos = pos
						info.lastMove = t
						if not info.hl or not info.hl.Parent then
							local color = info.isNPC and Color3.fromRGB(255, 60, 60) or Color3.fromRGB(0, 200, 255)
							info.hl = makeHighlight(obj, color)
						end
					elseif info.hl and (t - info.lastMove) > IDLE_TIMEOUT then
						info.hl:Destroy()
						info.hl = nil
					end
				end
			else
				stopTrack(obj)
			end
		end
		updateRadar()
	end
end)

---------------------------------------------------------
-- NIGHT VISION
---------------------------------------------------------
local function setNightVision(on)
	nightVisionOn = on
	if on then
		NightVisionBtn.Text = "ðŸŒ™ Night Vision: ON (M)"
		NightVisionBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
		Lighting.Brightness = 3
		Lighting.Ambient = Color3.fromRGB(120, 255, 120)
		Lighting.ColorShift_Top = Color3.fromRGB(120, 255, 120)
	else
		NightVisionBtn.Text = "ðŸŒ™ Night Vision: OFF (M)"
		NightVisionBtn.BackgroundColor3 = Color3.fromRGB(25, 80, 25)
		Lighting.Brightness = 1
		Lighting.Ambient = Color3.fromRGB(127, 127, 127)
		Lighting.ColorShift_Top = Color3.new(0, 0, 0)
	end
end

UserInputService.InputBegan:Connect(function(input, processed)
	if not processed and input.KeyCode == Enum.KeyCode.M then
		setNightVision(not nightVisionOn)
	end
end)
