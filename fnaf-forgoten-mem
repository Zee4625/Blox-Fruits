local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- CONFIGURAȚIE
local ESP_ENABLED = true
local TEXT_SIZE = 14
local MOVE_THRESHOLD = 0.05 -- Sensibilitate mișcare
local SCAN_INTERVAL = 5 -- Secunde între scanări pentru obiecte noi

local ESPColors = {
    -- FNAF 1 & 2
    ["Freddy"] = Color3.fromRGB(165, 42, 42),
    ["Bonnie"] = Color3.fromRGB(100, 0, 255),
    ["Chica"] = Color3.fromRGB(255, 255, 0),
    ["Foxy"] = Color3.fromRGB(255, 0, 0),
    ["Golden"] = Color3.fromRGB(255, 215, 0),
    ["Toy Freddy"] = Color3.fromRGB(180, 70, 70),
    ["Toy Bonnie"] = Color3.fromRGB(0, 180, 255),
    ["Toy Chica"] = Color3.fromRGB(255, 255, 100),
    ["Mangle"] = Color3.fromRGB(255, 200, 200),
    ["BB"] = Color3.fromRGB(255, 50, 50),
    ["Puppet"] = Color3.fromRGB(255, 255, 255),
    ["Marionette"] = Color3.fromRGB(255, 255, 255),
    ["Withered"] = Color3.fromRGB(100, 100, 100)
}

local ESPs = {}

function getAncorPart(target)
    if target:IsA("BasePart") then return target end
    local p = target:FindFirstChild("HumanoidRootPart") or target:FindFirstChild("Head") or target:FindFirstChild("Jaw")
    if p and p:IsA("BasePart") then return p end
    -- Căutare rapidă descendenți (limitată pentru a preveni lag-ul)
    local d = target:GetChildren()
    for i=1, #d do
        if d[i]:IsA("BasePart") then return d[i] end
    end
    return nil
end

function createESP(object)
    if ESPs[object] then return end
    
    local color = nil
    local cleanName = ""
    for name, col in pairs(ESPColors) do
        if string.find(object.Name, name) then
            color = col
            cleanName = name
            break
        end
    end
    
    if not color then return end

    local highlight = Instance.new("Highlight")
    highlight.Name = "Zee_FNAF_HL"
    highlight.Adornee = object
    highlight.FillColor = color
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Enabled = false
    highlight.Parent = object

    local tag = Drawing.new("Text")
    tag.Size = TEXT_SIZE
    tag.Outline = true
    tag.Center = true
    tag.Visible = false

    ESPs[object] = {
        Highlight = highlight,
        Tag = tag,
        Name = cleanName,
        Color = color,
        LastPos = Vector3.new(0,0,0),
        HasMovedOnce = false
    }
end

-- LOGICĂ UPDATE (RenderStepped)
RunService.RenderStepped:Connect(function()
    if not ESP_ENABLED then 
        for _, d in pairs(ESPs) do 
            d.Tag.Visible = false 
            d.Highlight.Enabled = false 
        end
        return 
    end

    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

    for obj, data in pairs(ESPs) do
        if not obj or not obj.Parent then
            data.Tag:Remove()
            if data.Highlight then data.Highlight:Destroy() end
            ESPs[obj] = nil
            continue
        end

        local part = getAncorPart(obj)
        if part then
            local currentPos = part.Position
            
            -- Detectăm dacă s-a mișcat măcar o dată
            if (currentPos - data.LastPos).Magnitude > MOVE_THRESHOLD then
                data.HasMovedOnce = true
            end
            data.LastPos = currentPos

            -- Afișăm doar dacă a fost detectată mișcare în trecut
            if data.HasMovedOnce then
                local pos, onScreen = Camera:WorldToViewportPoint(currentPos)
                if onScreen then
                    local dist = myRoot and math.floor((myRoot.Position - currentPos).Magnitude) or 0
                    
                    data.Tag.Text = string.format("%s\n[%dm]\n(ACTIVE)", data.Name, dist)
                    data.Tag.Position = Vector2.new(pos.X, pos.Y - 20)
                    data.Tag.Color = data.Color
                    data.Tag.Visible = true
                    data.Highlight.Enabled = true
                else
                    data.Tag.Visible = false
                    data.Highlight.Enabled = false
                end
            end
        end
    end
end)

-- SCANARE OPTIMIZATĂ (Fără Lag Spikes)
task.spawn(function()
    while true do
        local descendants = Workspace:GetDescendants()
        for i = 1, #descendants do
            local v = descendants[i]
            if v:IsA("Model") or v:IsA("Folder") then
                createESP(v)
            end
            -- Procesăm în bucăți pentru a nu bloca CPU-ul
            if i % 100 == 0 then task.wait() end
        end
        task.wait(SCAN_INTERVAL)
    end
end)

-- TOGGLE F6
UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.F6 then
        ESP_ENABLED = not ESP_ENABLED
    end
end)

print("ESP FNAF: Motion-Memory activat. F6 pentru Toggle.")
