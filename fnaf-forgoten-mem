local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- CONFIGURAȚIE
local ESP_ENABLED = true
local TEXT_SIZE = 14
local MOVE_THRESHOLD = 0.01 
local SCAN_INTERVAL = 5     

local ESPColors = {
    ["Freddy"] = Color3.fromRGB(165, 42, 42),
    ["Bonnie"] = Color3.fromRGB(100, 0, 255),
    ["Chica"] = Color3.fromRGB(255, 255, 0),
    ["Foxy"] = Color3.fromRGB(255, 0, 0),
    ["Golden"] = Color3.fromRGB(255, 215, 0),
    ["Toy Freddy"] = Color3.fromRGB(180, 70, 70),
    ["Toy Bonnie"] = Color3.fromRGB(0, 180, 255),
    ["Toy Chica"] = Color3.fromRGB(255, 255, 100),
    ["Mangle"] = Color3.fromRGB(255, 200, 200),
    ["BB"] = Color3.fromRGB(255, 50, 50),
    ["Puppet"] = Color3.fromRGB(255, 255, 255),
    ["Marionette"] = Color3.fromRGB(255, 255, 255),
    ["Withered"] = Color3.fromRGB(100, 100, 100),
    ["Shadow"] = Color3.fromRGB(50, 0, 100)
}

local ESPs = {}

function getAncorPart(target)
    if target:IsA("BasePart") then return target end
    local p = target:FindFirstChild("HumanoidRootPart") or target:FindFirstChild("Head") or target:FindFirstChild("Jaw")
    if p and p:IsA("BasePart") then return p end
    local children = target:GetChildren()
    for i = 1, math.min(#children, 10) do
        if children[i]:IsA("BasePart") then return children[i] end
    end
    return nil
end

function createESP(object)
    if ESPs[object] then return end
    
    local color = nil
    local cleanName = ""
    for name, col in pairs(ESPColors) do
        if string.find(object.Name, name) then
            color = col
            cleanName = name
            break
        end
    end
    
    if not color then return end

    local highlight = Instance.new("Highlight")
    highlight.Name = "Zee_FNAF_HL"
    highlight.Adornee = object
    highlight.FillColor = color
    highlight.OutlineColor = Color3.new(1, 1, 1)
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Enabled = false
    highlight.Parent = object

    -- Text Nume (Culoarea caracterului)
    local nameTag = Drawing.new("Text")
    nameTag.Size = TEXT_SIZE
    nameTag.Outline = true
    nameTag.Center = true
    nameTag.Visible = false

    -- Text Metri (Alb permanent)
    local meterTag = Drawing.new("Text")
    meterTag.Size = TEXT_SIZE - 2
    meterTag.Color = Color3.new(1, 1, 1) -- ALB
    meterTag.Outline = true
    meterTag.Center = true
    meterTag.Visible = false

    ESPs[object] = {
        Highlight = highlight,
        NameTag = nameTag,
        MeterTag = meterTag,
        Name = cleanName,
        Color = color,
        LastPos = Vector3.new(0,0,0),
        MoveCount = 0,
        IsPermanent = false
    }
end

RunService.RenderStepped:Connect(function()
    if not ESP_ENABLED then 
        for _, d in pairs(ESPs) do 
            d.NameTag.Visible = false 
            d.MeterTag.Visible = false
            d.Highlight.Enabled = false 
        end
        return 
    end

    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

    for obj, data in pairs(ESPs) do
        if not obj or not obj.Parent then
            data.NameTag:Remove()
            data.MeterTag:Remove()
            if data.Highlight then data.Highlight:Destroy() end
            ESPs[obj] = nil
            continue
        end

        local part = getAncorPart(obj)
        if part then
            local currentPos = part.Position
            local velocity = (currentPos - data.LastPos).Magnitude
            
            -- Logica de numărare a mișcărilor
            if velocity > MOVE_THRESHOLD then
                data.MoveCount = data.MoveCount + 1
                if data.MoveCount >= 2 then
                    data.IsPermanent = true
                end
            end
            data.LastPos = currentPos

            local pos, onScreen = Camera:WorldToViewportPoint(currentPos)
            
            -- Afișăm textele doar când se mișcă activ
            if onScreen and velocity > MOVE_THRESHOLD then
                local dist = myRoot and math.floor((myRoot.Position - currentPos).Magnitude) or 0
                
                data.NameTag.Text = data.Name .. " [MOVING]"
                data.NameTag.Position = Vector2.new(pos.X, pos.Y - 25)
                data.NameTag.Color = data.Color
                data.NameTag.Visible = true
                
                data.MeterTag.Text = dist .. "m"
                data.MeterTag.Position = Vector2.new(pos.X, pos.Y - 10)
                data.MeterTag.Visible = true
            else
                data.NameTag.Visible = false
                data.MeterTag.Visible = false
            end

            -- Highlight-ul devine permanent dacă s-a mișcat de 2 ori
            if data.IsPermanent then
                data.Highlight.Enabled = true
            elseif velocity > MOVE_THRESHOLD then
                data.Highlight.Enabled = true
            else
                data.Highlight.Enabled = false
            end
        end
    end
end)

task.spawn(function()
    while true do
        local descendants = Workspace:GetDescendants()
        for i = 1, #descendants do
            local v = descendants[i]
            if v:IsA("Model") or v:IsA("Folder") then
                createESP(v)
            end
            if i % 150 == 0 then task.wait() end
        end
        task.wait(SCAN_INTERVAL)
    end
end)

UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.F6 then
        ESP_ENABLED = not ESP_ENABLED
    end
end)

print("ESP FNAF: Permanent Highlight on Move x2 Incarcat!")
