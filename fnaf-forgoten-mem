local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- CONFIGURAȚIE
local ESP_ENABLED = true
local TEXT_SIZE = 14
local MOVE_THRESHOLD = 0.01 -- Sensibilitate foarte mare la mișcare
local SCAN_INTERVAL = 4     -- Secunde între scanări pentru obiecte noi

local ESPColors = {
    -- FNAF 1 & 2
    ["Freddy"] = Color3.fromRGB(165, 42, 42),
    ["Bonnie"] = Color3.fromRGB(100, 0, 255),
    ["Chica"] = Color3.fromRGB(255, 255, 0),
    ["Foxy"] = Color3.fromRGB(255, 0, 0),
    ["Golden"] = Color3.fromRGB(255, 215, 0),
    ["Toy Freddy"] = Color3.fromRGB(180, 70, 70),
    ["Toy Bonnie"] = Color3.fromRGB(0, 180, 255),
    ["Toy Chica"] = Color3.fromRGB(255, 255, 100),
    ["Mangle"] = Color3.fromRGB(255, 200, 200),
    ["BB"] = Color3.fromRGB(255, 50, 50),
    ["Balloon Boy"] = Color3.fromRGB(255, 50, 50),
    ["Puppet"] = Color3.fromRGB(255, 255, 255),
    ["Marionette"] = Color3.fromRGB(255, 255, 255),
    ["Withered"] = Color3.fromRGB(100, 100, 100),
    ["Shadow"] = Color3.fromRGB(50, 0, 100)
}

local ESPs = {}

-- Găsește o piesă validă pentru ancorare
function getAncorPart(target)
    if target:IsA("BasePart") then return target end
    local p = target:FindFirstChild("HumanoidRootPart") or target:FindFirstChild("Head") or target:FindFirstChild("Jaw")
    if p and p:IsA("BasePart") then return p end
    
    -- Căutare rapidă în copii (max 10 pentru a evita lagul)
    local children = target:GetChildren()
    for i = 1, math.min(#children, 10) do
        if children[i]:IsA("BasePart") then return children[i] end
    end
    return nil
end

function createESP(object)
    if ESPs[object] then return end
    
    local color = nil
    local cleanName = ""
    for name, col in pairs(ESPColors) do
        if string.find(object.Name, name) then
            color = col
            cleanName = name
            break
        end
    end
    
    if not color then return end

    local highlight = Instance.new("Highlight")
    highlight.Name = "Zee_FNAF_HL"
    highlight.Adornee = object
    highlight.FillColor = color
    highlight.OutlineColor = Color3.new(1, 1, 1)
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Enabled = false
    highlight.Parent = object

    local tag = Drawing.new("Text")
    tag.Size = TEXT_SIZE
    tag.Outline = true
    tag.Center = true
    tag.Visible = false

    ESPs[object] = {
        Highlight = highlight,
        Tag = tag,
        Name = cleanName,
        Color = color,
        LastPos = Vector3.new(0,0,0)
    }
end

-- LOGICĂ UPDATE (Randează cadrele)
RunService.RenderStepped:Connect(function()
    if not ESP_ENABLED then 
        for _, d in pairs(ESPs) do 
            d.Tag.Visible = false 
            d.Highlight.Enabled = false 
        end
        return 
    end

    local char = LocalPlayer.Character
    local myRoot = char and char:FindFirstChild("HumanoidRootPart")

    for obj, data in pairs(ESPs) do
        if not obj or not obj.Parent then
            data.Tag:Remove()
            if data.Highlight then data.Highlight:Destroy() end
            ESPs[obj] = nil
            continue
        end

        local part = getAncorPart(obj)
        if part then
            local currentPos = part.Position
            -- Calculăm dacă se mișcă în acest moment
            local velocity = (currentPos - data.LastPos).Magnitude
            data.LastPos = currentPos

            -- DOAR DACĂ SE MIȘCĂ (velocity > 0.01)
            if velocity > MOVE_THRESHOLD then
                local pos, onScreen = Camera:WorldToViewportPoint(currentPos)
                
                if onScreen then
                    local dist = myRoot and math.floor((myRoot.Position - currentPos).Magnitude) or 0
                    
                    data.Tag.Text = string.format("%s\n[%dm]\nMOVING", data.Name, dist)
                    data.Tag.Position = Vector2.new(pos.X, pos.Y - 20)
                    data.Tag.Color = data.Color
                    data.Tag.Visible = true
                    data.Highlight.Enabled = true
                else
                    data.Tag.Visible = false
                    data.Highlight.Enabled = false
                end
            else
                -- DACĂ STĂ PE LOC, ASCUNDE TOT
                data.Tag.Visible = false
                data.Highlight.Enabled = false
            end
        end
    end
end)

-- SCANARE OPTIMIZATĂ PENTRU A EVITA LAG SPIKES
task.spawn(function()
    while true do
        local descendants = Workspace:GetDescendants()
        for i = 1, #descendants do
            local v = descendants[i]
            if v:IsA("Model") or v:IsA("Folder") or v:IsA("Configuration") then
                createESP(v)
            end
            -- Oprește execuția scurt la fiecare 150 de obiecte pentru a lăsa procesorul să respire
            if i % 150 == 0 then task.wait() end
        end
        task.wait(SCAN_INTERVAL)
    end
end)

-- TOGGLE F6
UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.F6 then
        ESP_ENABLED = not ESP_ENABLED
    end
end)

print("Sistem Motion ESP FNAF Incarcat! [F6]")
